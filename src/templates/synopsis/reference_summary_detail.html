{% extends "synopsis/base.html" %}
{% block title %}Reference summary – {{ project.title }}{% endblock %}
{% block content %}
{{ summary_form.media }}
<h1 class="mb-3">Reference summary</h1>
<div class="d-flex flex-wrap gap-2 mb-4">
    <a class="btn btn-outline-secondary" href="{% url 'synopsis:reference_summary_board' project.id %}">Back to summaries</a>
    <a class="btn btn-outline-primary" href="{% url 'synopsis:reference_batch_list' project.id %}">Screening overview</a>
    <button class="btn btn-outline-secondary" type="button" data-bs-toggle="modal" data-bs-target="#snapshotModal">Snapshot & comments</button>
</div>
<div class="card mb-4">
    <div class="card-body">
        <h4 class="mb-1">{{ reference.title }}</h4>
        <div class="text-muted mb-2">
            {% if reference.authors %}{{ reference.authors }}{% else %}Unknown authors{% endif %}
            {% if reference.publication_year %} · {{ reference.publication_year }}{% endif %}
        </div>
        {% if reference.abstract %}
        <div class="position-relative">
            <div id="abstract-preview" class="mb-2" style="max-height: 6rem; overflow: hidden;">
                <p class="mb-0">{{ reference.abstract }}</p>
            </div>
            <button class="btn btn-outline-link btn-sm p-0" type="button" id="toggle-abstract">Show more</button>
        </div>
        {% else %}
        <p class="text-muted mb-0">No abstract available.</p>
        {% endif %}
    </div>
</div>
<div class="row g-3">
    <div class="col-xl-6 col-12 d-flex flex-column">
        <div class="card flex-grow-1 shadow-sm" id="pdf-card" style="position: sticky; top: 1rem;">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>Reference PDF</span>
                {% if reference.reference_document %}
                <div class="btn-group btn-group-sm" role="group" aria-label="PDF actions">
                    <a class="btn btn-outline-primary" href="{% url 'synopsis:reference_document_inline' project.id reference.id %}?v={{ reference.reference_document_uploaded_at|date:'U' }}" target="_blank" rel="noopener">Open in new tab</a>
                    <a class="btn btn-outline-secondary" href="{{ reference.reference_document.url }}" target="_blank" rel="noopener" download>Download</a>
                </div>
                {% endif %}
            </div>
            <div class="card-body d-flex flex-column gap-3" id="pdf-card-body" style="overflow-y: auto;">
                <form method="post" enctype="multipart/form-data" class="mb-1" id="pdf-upload-form">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="upload-document">
                    {{ document_form.document }}
                    <button class="btn btn-outline-primary btn-sm mt-2 d-none" type="submit">Upload PDF</button>
                </form>
                {% if reference.reference_document %}
                    <div class="small text-muted">
                        {% if reference.reference_document_uploaded_at %}
                            Uploaded {{ reference.reference_document_uploaded_at|date:"Y-m-d H:i" }}
                        {% else %}
                            PDF available
                        {% endif %}
                    </div>
                    <div class="flex-grow-1 position-relative" id="pdf-viewer" style="min-height: 400px; background: #f8f9fa; border: 1px solid #e2e6ea; border-radius: 0.5rem; box-shadow: inset 0 1px 2px rgba(0,0,0,0.04); padding: 0.5rem;">
                        <object
                            data="{% url 'synopsis:reference_document_inline' project.id reference.id %}?inline=1&v={{ reference.reference_document_uploaded_at|date:'U' }}"
                            type="application/pdf"
                            width="100%"
                            height="100%"
                        >
                            <iframe
                                src="{% url 'synopsis:reference_document_inline' project.id reference.id %}?inline=1&v={{ reference.reference_document_uploaded_at|date:'U' }}#view=FitH"
                                title="PDF preview"
                                loading="lazy"
                                style="width: 100%; height: 100%; border: 0;"
                                referrerpolicy="no-referrer"
                            ></iframe>
                            <p class="mt-2">
                                Your browser can't display this PDF. <a href="{% url 'synopsis:reference_document_inline' project.id reference.id %}?v={{ reference.reference_document_uploaded_at|date:'U' }}" target="_blank" rel="noopener">Download it instead.</a>
                            </p>
                        </object>
                    </div>
                {% else %}
                    <p class="text-muted mb-0">No PDF uploaded yet.</p>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="col-xl-6 col-12">
        <div class="card mb-3 shadow-sm" id="summary-card">
            <div class="card-header">Summary details</div>
            <div class="card-body">
                <form method="post" class="d-flex flex-column gap-4">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="save-summary">
                    <div>
                        <div class="text-uppercase text-muted small fw-semibold mb-2">Identifiers</div>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Reference ID</label>
                                {{ summary_form.reference_identifier }}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Summary ID</label>
                                {{ summary_form.summary_identifier }}
                            </div>
                        </div>
                    </div>
                    <div>
                        <div class="text-uppercase text-muted small fw-semibold mb-2">Study overview</div>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Reference</label>
                                {{ summary_form.reference_label }}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Action</label>
                                {{ summary_form.action_description }}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Study design</label>
                                {{ summary_form.study_design }}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Type of study</label>
                                {{ summary_form.study_type }}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Number of sites/replications</label>
                                {{ summary_form.sites_replications }}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Years X-Y</label>
                                {{ summary_form.year_range }}
                            </div>
                        </div>
                    </div>
                    <div>
                        <div class="text-uppercase text-muted small fw-semibold mb-2">Habitat & geography</div>
                        <div class="row g-3">
                            <div class="col-12">
                                <label class="form-label">Habitat and number of sites</label>
                                {{ summary_form.habitat_and_sites }}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Region</label>
                                {{ summary_form.region }}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Country</label>
                                {{ summary_form.country }}
                            </div>
                        </div>
                    </div>
                    <div>
                        <div class="text-uppercase text-muted small fw-semibold mb-2">Findings & methods</div>
                        <div class="mb-3">
                            <label class="form-label">Summary of results (action + outcome)</label>
                            {{ summary_form.summary_of_results }}
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Outcome rows</label>
                            {{ summary_form.outcomes_raw }}
                            <div class="form-text">One outcome per line, fields separated by | (Outcome | Treatment value(s) | Treatment | Comparator value(s) | Comparator | Unit | Difference | Stats | p value | Notes).</div>
                        </div>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Action methods</label>
                                {{ summary_form.action_methods }}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Experimental design</label>
                                {{ summary_form.experimental_design }}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Key details of site context</label>
                                {{ summary_form.site_context_details }}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Details of sampling methods</label>
                                {{ summary_form.sampling_methods_details }}
                            </div>
                        </div>
                    </div>
                    <div>
                        <div class="text-uppercase text-muted small fw-semibold mb-2">Costs</div>
                        <div class="mb-0">
                            <label class="form-label">Costs</label>
                            {{ summary_form.cost_summary }}
                        </div>
                    </div>
                    <div>
                        <div class="text-uppercase text-muted small fw-semibold mb-2">Tags & design</div>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Action tags (IUCN)</label>
                                {{ summary_form.action_tags }}
                                <div class="form-text">Select all applicable interventions.</div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Threat tags (IUCN)</label>
                                {{ summary_form.threat_tags }}
                                <div class="form-text">Select all applicable threats.</div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Habitat tags (IUCN)</label>
                                {{ summary_form.habitat_tags }}
                                <div class="form-text">Select all applicable habitats.</div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Taxon tags</label>
                                {{ summary_form.taxon_tags }}
                                <div class="form-text">Binomial + common names, comma-separated.</div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Location tags</label>
                                {{ summary_form.location_tags }}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Research design</label>
                                {{ summary_form.research_design }}
                            </div>
                            <div class="col-md-12">
                                <label class="form-label">Citation</label>
                                {{ summary_form.citation }}
                            </div>
                        </div>
                    </div>
                    <div>
                        <div class="text-uppercase text-muted small fw-semibold mb-2">CE metadata</div>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Summary author</label>
                                {{ summary_form.summary_author }}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Broad category</label>
                                {{ summary_form.broad_category }}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Keywords</label>
                                {{ summary_form.keywords }}
                                <div class="form-text">Comma-separated key terms or synonyms.</div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">URL</label>
                                {{ summary_form.source_url }}
                                <div class="form-text">Stable link (DOI or landing page).</div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Crop type (if relevant)</label>
                                {{ summary_form.crop_type }}
                            </div>
                        </div>
                    </div>
                    <div>
                        <div class="text-uppercase text-muted small fw-semibold mb-2">Quality scores</div>
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label class="form-label">Benefits</label>
                                {{ summary_form.benefits_score }}
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Harms</label>
                                {{ summary_form.harms_score }}
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Reliability</label>
                                {{ summary_form.reliability_score }}
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Relevance</label>
                                {{ summary_form.relevance_score }}
                            </div>
                        </div>
                    </div>
                    <div class="pt-2">
                        <button class="btn btn-primary">Save summary</button>
                    </div>
                </form>
            </div>
        </div>
        <div class="card mb-3 shadow-sm">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>Generated summary paragraph</span>
                {% if generated_summary %}
                <button class="btn btn-outline-secondary btn-sm" type="button" id="copy-generated-summary">Copy</button>
                {% endif %}
            </div>
            <div class="card-body">
                {% if generated_summary %}
                    <p class="text-muted small mb-2">Auto-built from the structured fields above - use as a starting point.</p>
                    <pre class="bg-light border rounded p-3" style="white-space: pre-wrap;">{{ generated_summary }}</pre>
                {% else %}
                    <p class="text-muted mb-0">Fill in the structured fields to generate a summary paragraph.</p>
                {% endif %}
            </div>
        </div>
        <div class="card mb-3 shadow-sm">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>Action-specific summaries</span>
                <span class="badge text-bg-light">{{ action_summaries|length }} total</span>
            </div>
            <div class="card-body">
                <div class="alert alert-info py-2 small mb-3">
                    Write one action summary per intervention when results are separate. If only combined results exist, repeat the paragraph under each intervention and state which interventions were applied together, noting that effects can’t be separated. Consider a single combined intervention only when ≥5 studies use the same well-defined bundle that is a common strategy.
                </div>
                {% if action_summaries %}
                    {% for action_summary in action_summaries %}
                    <div class="border rounded p-3 mb-3">
                        <div class="d-flex justify-content-between align-items-start gap-3">
                            <div>
                                <div class="fw-semibold">{{ action_summary.action_name }}</div>
                                <div class="small text-muted">Last updated {{ action_summary.updated_at|date:"Y-m-d H:i" }}</div>
                            </div>
                            <form method="post" onsubmit="return confirm('Delete this action summary?');">
                                {% csrf_token %}
                                <input type="hidden" name="action" value="delete-action-summary">
                                <input type="hidden" name="action_summary_id" value="{{ action_summary.id }}">
                                <button class="btn btn-outline-danger btn-sm">Delete</button>
                            </form>
                        </div>
                        <p class="mt-2 mb-3">{{ action_summary.summary_text|linebreaksbr }}</p>
                        <form method="post">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="edit-action-summary">
                            <input type="hidden" name="action_summary_id" value="{{ action_summary.id }}">
                            <div class="row g-2">
                                <div class="col-md-4">
                                    <label class="form-label small text-muted">Action name</label>
                                    <input type="text" class="form-control form-control-sm" name="action_name" value="{{ action_summary.action_name }}">
                                </div>
                                <div class="col-md-8">
                                    <label class="form-label small text-muted">Summary (~200 words)</label>
                                    <textarea class="form-control form-control-sm" rows="3" name="summary_text" maxlength="1500">{{ action_summary.summary_text }}</textarea>
                                    <div class="form-text">Aim for 150–200 words.</div>
                                </div>
                            </div>
                            <button class="btn btn-outline-primary btn-sm mt-2">Save changes</button>
                        </form>
                    </div>
                    {% endfor %}
                {% else %}
                    <p class="text-muted">No action-specific summaries yet—use the form below to add one for each intervention this study tests.</p>
                {% endif %}
                <hr>
                <form method="post">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="add-action-summary">
                    <div class="mb-3">
                        <label class="form-label">Action name</label>
                        {{ action_summary_form.action_name }}
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Action summary (~200 words)</label>
                        {{ action_summary_form.summary_text }}
                        <div class="form-text">Aim for 150–200 words.</div>
                    </div>
                    <button class="btn btn-success">Add action summary</button>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="snapshotModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <div>
            <h5 class="modal-title mb-0">Snapshot & comments</h5>
            <small class="text-muted">{{ reference.title }}</small>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
            <dl class="row mb-0">
                <dt class="col-sm-4">Status</dt>
                <dd class="col-sm-8">{{ summary.get_status_display }}</dd>
                <dt class="col-sm-4">Needs help?</dt>
                <dd class="col-sm-8">{% if summary.needs_help %}Yes{% else %}No{% endif %}</dd>
                <dt class="col-sm-4">Assigned to</dt>
                <dd class="col-sm-8">{% if summary.assigned_to %}{{ summary.assigned_to.get_full_name|default:summary.assigned_to.username }}{% else %}<span class="text-muted">Unassigned</span>{% endif %}</dd>
                <dt class="col-sm-4">Last updated</dt>
                <dd class="col-sm-8">{{ summary.updated_at|date:"Y-m-d H:i" }}</dd>
            </dl>
        </div>
        <hr>
        <div>
            <div class="fw-semibold mb-2">Comments</div>
            {% if comments %}
                <div class="mb-3">
                    {% for comment in comments %}
                        <div class="mb-3 border-bottom pb-2">
                            <div class="small text-muted">{{ comment.author.get_full_name|default:comment.author.username }} · {{ comment.created_at|date:"Y-m-d H:i" }}</div>
                            <p class="mb-0">{{ comment.body|linebreaksbr }}</p>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <p class="text-muted">No comments yet.</p>
            {% endif %}
            <form method="post">
                {% csrf_token %}
                <input type="hidden" name="action" value="comment">
                {{ comment_form.body }}
                <button class="btn btn-outline-primary mt-2">Add comment</button>
            </form>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

{% if generated_summary %}
{{ generated_summary|json_script:"generated-summary-data" }}
<script>
    (function() {
        const btn = document.getElementById("copy-generated-summary");
        const dataEl = document.getElementById("generated-summary-data");
        if (!btn || !dataEl || !navigator.clipboard) return;
        let summaryText = "";
        try {
            summaryText = JSON.parse(dataEl.textContent);
        } catch (e) {
            console.warn("Could not parse generated summary payload");
            return;
        }
        btn.addEventListener("click", () => {
            navigator.clipboard.writeText(summaryText)
                .then(() => {
                    btn.textContent = "Copied";
                    setTimeout(() => { btn.textContent = "Copy"; }, 1500);
                })
                .catch(() => {
                    btn.textContent = "Copy failed";
                    setTimeout(() => { btn.textContent = "Copy"; }, 1500);
                });
        });
    })();
</script>
{% endif %}
<script>
    (() => {
        const pdfCard = document.getElementById("pdf-card");
        const pdfBody = document.getElementById("pdf-card-body");
        const summaryCard = document.getElementById("summary-card");
        if (!pdfCard || !pdfBody || !summaryCard) return;

        const syncHeights = () => {
            const summaryHeight = summaryCard.getBoundingClientRect().height;
            if (!summaryHeight) return;
            const viewportAllowance = Math.max(window.innerHeight - 32, 320); // keep visible while sticky
            const targetHeight = Math.min(summaryHeight, viewportAllowance);
            pdfCard.style.height = `${targetHeight}px`;
            pdfCard.style.maxHeight = `${targetHeight}px`;
            const header = pdfCard.querySelector(".card-header");
            const headerHeight = header ? header.getBoundingClientRect().height : 0;
            const bodyStyles = window.getComputedStyle(pdfBody);
            const paddingTop = parseFloat(bodyStyles.paddingTop) || 0;
            const paddingBottom = parseFloat(bodyStyles.paddingBottom) || 0;
            const available = targetHeight - headerHeight - paddingTop - paddingBottom;
            if (available > 0) {
                pdfBody.style.height = `${available}px`;
                pdfBody.style.maxHeight = `${available}px`;
            }
        };

        const resizeObserver = new ResizeObserver(syncHeights);
        resizeObserver.observe(summaryCard);
        window.addEventListener("resize", syncHeights);
        syncHeights();
    })();
</script>
<script>
    (() => {
        const preview = document.getElementById("abstract-preview");
        const toggle = document.getElementById("toggle-abstract");
        if (preview && toggle) {
            let expanded = false;
            toggle.addEventListener("click", () => {
                expanded = !expanded;
                if (expanded) {
                    preview.style.maxHeight = "none";
                    toggle.textContent = "Show less";
                } else {
                    preview.style.maxHeight = "6rem";
                    toggle.textContent = "Show more";
                    preview.scrollIntoView({ behavior: "smooth", block: "center" });
                }
            });
        }
    })();
</script>
<script>
    (() => {
        const uploadForm = document.getElementById("pdf-upload-form");
        if (!uploadForm) return;
        const fileInput = uploadForm.querySelector("input[type='file']");
        if (!fileInput) return;
        fileInput.addEventListener("change", () => {
            if (fileInput.files && fileInput.files.length > 0) {
                uploadForm.submit();
            }
        });
    })();
</script>
{% endblock %}
