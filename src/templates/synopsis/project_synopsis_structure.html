{% extends "synopsis/base.html" %}

{% block title %}{{ project.title }} — Synopsis structure{% endblock %}

{% block content %}
<div class="bg-white p-4 rounded shadow-sm mb-3">
    <div class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-center gap-3">
        <div>
            <p class="text-uppercase text-muted small mb-1">Synopsis structure</p>
            <h1 class="h3 mb-0">{{ project.title }}</h1>
            <div class="small text-muted">Last exported: {{ last_exported|default:"—" }}</div>
        </div>
        <div class="d-flex flex-wrap gap-2">
            <a class="btn btn-outline-secondary btn-sm" href="{% url 'synopsis:reference_summary_board' project.id %}">Back to summary workspace</a>
            <a class="btn btn-success btn-sm" href="{% url 'synopsis:project_synopsis_export_docx' project.id %}">Export to DOCX</a>
        </div>
    </div>
    <p class="text-muted small mb-0">Chapters → subheadings → interventions. Drop in summaries, reorder, then export to OnlyOffice.</p>
</div>

<div class="row g-3">
    <div class="col-lg-4">
        <div class="card mb-3">
            <div class="card-body">
                <h2 class="h6 text-uppercase text-muted mb-3">Add a chapter</h2>
                <form method="post" novalidate>
                    {% csrf_token %}
                    <input type="hidden" name="action" value="create-chapter">
                    <div class="mb-2">{{ chapter_form.title.label_tag }}{{ chapter_form.title }}</div>
                    <button type="submit" class="btn btn-primary w-100 btn-sm">Create chapter</button>
                </form>
            </div>
        </div>
        <div class="card">
            <div class="card-body">
                <h2 class="h6 text-uppercase text-muted mb-2">Chapters</h2>
                <div class="mb-3">
                    <form method="post" class="d-flex gap-2 align-items-center">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="apply-preset">
                        <select name="preset_key" class="form-select form-select-sm">
                            {% for preset in presets %}
                                <option value="{{ preset.key }}">{{ preset.label }}</option>
                            {% endfor %}
                        </select>
                        <button class="btn btn-outline-primary btn-sm" {% if chapters %}disabled{% endif %}>Apply</button>
                    </form>
                    <form method="post" class="mt-2">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="reset-structure">
                        <button class="btn btn-outline-danger btn-sm" {% if not chapters %}disabled{% endif %} onclick="return confirm('Clear all chapters and start over?')">Remove preset / clear outline</button>
                    </form>
                    <div class="small text-muted mt-1">Presets can be applied only when the outline is empty.</div>
                </div>
                <div class="list-group">
                    {% for chapter in chapters %}
                        <a class="list-group-item list-group-item-action" href="#chapter-{{ chapter.id }}">{{ chapter.title }}</a>
                    {% empty %}
                        <div class="text-muted small">No chapters yet.</div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-8">
        {% for chapter in chapters %}
        <div class="card mb-3" id="chapter-{{ chapter.id }}">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div class="fw-semibold">{{ chapter.title }}</div>
                <div class="btn-group btn-group-sm" role="group">
                    <form method="post" class="d-inline">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="move-chapter">
                        <input type="hidden" name="chapter_id" value="{{ chapter.id }}">
                        <input type="hidden" name="direction" value="up">
                        <button class="btn btn-outline-secondary" title="Move up">↑</button>
                    </form>
                    <form method="post" class="d-inline">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="move-chapter">
                        <input type="hidden" name="chapter_id" value="{{ chapter.id }}">
                        <input type="hidden" name="direction" value="down">
                        <button class="btn btn-outline-secondary" title="Move down">↓</button>
                    </form>
                    <form method="post" class="d-inline">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="delete-chapter">
                        <input type="hidden" name="chapter_id" value="{{ chapter.id }}">
                        <button class="btn btn-outline-danger" title="Delete" onclick="return confirm('Delete this chapter and everything inside it?')">✕</button>
                    </form>
                </div>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="text-muted small text-uppercase">Chapter background</span>
                    </div>
                    <form method="post" class="mt-2">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="update-chapter-background">
                        <input type="hidden" name="chapter_id" value="{{ chapter.id }}">
                        <div class="mb-2">
                            <textarea name="background_text" class="form-control form-control-sm" rows="3" placeholder="Brief background (<200 words): describe intervention scope, context, key literature/harms.">{{ chapter.background_text }}</textarea>
                        </div>
                        <div class="mb-2">
                            <textarea name="background_references" class="form-control form-control-sm" rows="2" placeholder="Background references (one per line, published before search end date).">{{ chapter.background_references }}</textarea>
                        </div>
                        <button class="btn btn-outline-primary btn-sm">Save background</button>
                    </form>
                </div>
                <h6 class="text-muted text-uppercase small mb-2">Subheadings</h6>
                <div class="mb-2">
                    <form method="post" class="row g-2 align-items-center">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="create-subheading">
                        <input type="hidden" name="chapter_id" value="{{ chapter.id }}">
                        <div class="col-8 col-md-9">
                            {{ subheading_form.title }}
                        </div>
                        <div class="col-4 col-md-3">
                            <button class="btn btn-outline-primary w-100 btn-sm">Add</button>
                        </div>
                    </form>
                </div>

                {% for subheading in chapter.subheadings.all %}
                <div class="border rounded p-2 mb-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="fw-semibold">{{ subheading.title }}</div>
                        <div class="btn-group btn-group-sm">
                            <form method="post" class="d-inline">
                                {% csrf_token %}
                                <input type="hidden" name="action" value="move-subheading">
                                <input type="hidden" name="subheading_id" value="{{ subheading.id }}">
                                <input type="hidden" name="direction" value="up">
                                <button class="btn btn-outline-secondary">↑</button>
                            </form>
                            <form method="post" class="d-inline">
                                {% csrf_token %}
                                <input type="hidden" name="action" value="move-subheading">
                                <input type="hidden" name="subheading_id" value="{{ subheading.id }}">
                                <input type="hidden" name="direction" value="down">
                                <button class="btn btn-outline-secondary">↓</button>
                            </form>
                            <form method="post" class="d-inline">
                                {% csrf_token %}
                                <input type="hidden" name="action" value="delete-subheading">
                                <input type="hidden" name="subheading_id" value="{{ subheading.id }}">
                                <button class="btn btn-outline-danger" onclick="return confirm('Delete this subheading and its interventions?')">✕</button>
                            </form>
                        </div>
                    </div>

                    <div class="mt-2 ms-2">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="text-muted small text-uppercase">Interventions</span>
                            <form method="post" class="d-inline-flex gap-2">
                                {% csrf_token %}
                                <input type="hidden" name="action" value="create-intervention">
                                <input type="hidden" name="subheading_id" value="{{ subheading.id }}">
                                {{ intervention_form.title }}
                                <button class="btn btn-outline-primary btn-sm">Add</button>
                            </form>
                        </div>

                        {% for intervention in subheading.interventions.all %}
                        <div class="border rounded p-2 mb-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="fw-semibold">{{ intervention.title }}</div>
                                <div class="btn-group btn-group-sm">
                                    <form method="post" class="d-inline">
                                        {% csrf_token %}
                                        <input type="hidden" name="action" value="move-intervention">
                                        <input type="hidden" name="intervention_id" value="{{ intervention.id }}">
                                        <input type="hidden" name="direction" value="up">
                                        <button class="btn btn-outline-secondary">↑</button>
                                    </form>
                                    <form method="post" class="d-inline">
                                        {% csrf_token %}
                                        <input type="hidden" name="action" value="move-intervention">
                                        <input type="hidden" name="intervention_id" value="{{ intervention.id }}">
                                        <input type="hidden" name="direction" value="down">
                                        <button class="btn btn-outline-secondary">↓</button>
                                    </form>
                                    <form method="post" class="d-inline">
                                        {% csrf_token %}
                                        <input type="hidden" name="action" value="delete-intervention">
                                        <input type="hidden" name="intervention_id" value="{{ intervention.id }}">
                                        <button class="btn btn-outline-danger" onclick="return confirm('Delete this intervention and its summaries?')">✕</button>
                                    </form>
                                </div>
                            </div>

                            <div class="mt-2">
                                <div class="mb-2">
                                    <form method="post" class="d-flex flex-column gap-2">
                                        {% csrf_token %}
                                        <input type="hidden" name="action" value="update-intervention-background">
                                        <input type="hidden" name="intervention_id" value="{{ intervention.id }}">
                                        <textarea name="background_text" class="form-control form-control-sm" rows="3" placeholder="Background (<200 words): describe the intervention, context, related literature/harms.">{{ intervention.background_text }}</textarea>
                                        <textarea name="background_references" class="form-control form-control-sm" rows="2" placeholder="Background references (one per line, pre-search-end).">{{ intervention.background_references }}</textarea>
                                        <div class="d-flex justify-content-end">
                                            <button class="btn btn-outline-primary btn-sm">Save background</button>
                                        </div>
                                    </form>
                                </div>
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <span class="text-muted small text-uppercase">Assigned summaries</span>
                                    <form method="post" class="d-inline-flex gap-2 align-items-center">
                                        {% csrf_token %}
                                        <input type="hidden" name="action" value="add-assignment">
                                        <input type="hidden" name="intervention_id" value="{{ intervention.id }}">
                                        <input type="text" class="form-control form-control-sm summary-filter" data-target="summary-select-{{ intervention.id }}" placeholder="Filter">
                                        <select id="summary-select-{{ intervention.id }}" name="summary" class="form-select form-select-sm">
                                            <option value="">Select summary…</option>
                                            {% for summary in reference_summaries %}
                                                <option value="{{ summary.id }}">{{ summary.reference.title }}</option>
                                            {% endfor %}
                                        </select>
                                        <button class="btn btn-outline-primary btn-sm">Add</button>
                                    </form>
                                </div>

                                <ul class="list-group assignment-list" data-intervention="{{ intervention.id }}">
                                    {% for assignment in intervention.assignments.all %}
                                    <li class="list-group-item d-flex justify-content-between align-items-center" draggable="true" data-assignment-id="{{ assignment.id }}">
                                        <span class="me-2">☰</span>
                                        <div class="flex-grow-1">{{ assignment.reference_summary.reference.title }}</div>
                                        <form method="post" class="ms-2">
                                            {% csrf_token %}
                                            <input type="hidden" name="action" value="delete-assignment">
                                            <input type="hidden" name="assignment_id" value="{{ assignment.id }}">
                                            <button class="btn btn-outline-danger btn-sm">Remove</button>
                                        </form>
                                    </li>
                                    {% empty %}
                                    <li class="list-group-item text-muted small">No summaries yet.</li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                        {% empty %}
                        <div class="text-muted small ms-2">No interventions yet.</div>
                        {% endfor %}
                    </div>
                </div>
                {% empty %}
                <div class="text-muted small">No subheadings yet.</div>
                {% endfor %}
            </div>
        </div>
        {% empty %}
        <div class="alert alert-secondary">No chapters yet. Use the form on the left to add one.</div>
        {% endfor %}
    </div>
</div>

<script>
    (() => {
        const getCookie = (name) => {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return "";
        };
        const csrftoken = getCookie("csrftoken");

        document.querySelectorAll(".summary-filter").forEach((input) => {
            input.addEventListener("input", () => {
                const target = document.getElementById(input.dataset.target);
                if (!target) return;
                const q = input.value.toLowerCase();
                Array.from(target.options).forEach((opt, idx) => {
                    if (idx === 0) return;
                    opt.hidden = q && !opt.textContent.toLowerCase().includes(q);
                });
            });
        });

        document.querySelectorAll(".assignment-list").forEach((list) => {
            let dragged = null;
            list.addEventListener("dragstart", (e) => {
                const li = e.target.closest("li[data-assignment-id]");
                if (!li) return;
                dragged = li;
                e.dataTransfer.effectAllowed = "move";
            });
            list.addEventListener("dragover", (e) => {
                e.preventDefault();
                const li = e.target.closest("li[data-assignment-id]");
                if (!li || li === dragged) return;
                const rect = li.getBoundingClientRect();
                const offset = e.clientY - rect.top;
                if (offset > rect.height / 2) {
                    li.after(dragged);
                } else {
                    li.before(dragged);
                }
            });
            list.addEventListener("drop", (e) => {
                e.preventDefault();
                const ids = Array.from(list.querySelectorAll("li[data-assignment-id]")).map((li) =>
                    li.getAttribute("data-assignment-id")
                );
                if (!csrftoken) {
                    console.warn("Missing CSRF token; reorder not sent.");
                    dragged = null;
                    return;
                }
                fetch(window.location.href, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": csrftoken,
                    },
                    body: JSON.stringify({
                        action: "reorder-assignments",
                        assignment_ids: ids,
                        intervention_id: list.getAttribute("data-intervention"),
                    }),
                }).catch(() => {});
                dragged = null;
            });
        });
    })();
</script>
{% endblock %}
