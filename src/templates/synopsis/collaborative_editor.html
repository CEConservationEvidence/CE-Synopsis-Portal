{% extends "synopsis/base.html" %}
{% block title %}Collaborative Editor – {{ document_label }}{% endblock %}
{% block page_container_class %}container-fluid p-0{% endblock %}
{% block content %}
// TODO: #42 It seems there is a bug when closing the window does not close the interactive collab session on onlyoffice server. Need to handle this so when closed the session is closed properly and no edits are made.
// TODO: #45 # Need to consider handling reconnecting to the session if the user loses connection temporarily.
// TODO: #46 need to consider adding a notice about autosave and how often changes are saved.
// TODO: #47 close to issue 42, the message to show if window is closed without ending the session properly is not displaying. Need to investigate further.
// TODO: #44 need to consider adding a warning when the user attempts to close the tab/window while editing.
<div class="collab-header py-3 px-3 px-md-4">
    <h1 class="mb-2">Collaborative editor – {{ document_label }}</h1>
    <div class="d-flex flex-wrap justify-content-between align-items-center gap-2">
        <div>
            <div class="fw-semibold">{{ project.title }}</div>
            <a class="small" href="{{ detail_url }}">Back to {{ document_label|lower }} detail</a>
        </div>
        {% if can_force_end %}
        <form
            method="post"
            action="{{ force_end_url }}"
            class="d-inline"
            onsubmit="return confirm('End this collaborative session for everyone?');"
        >
            {% csrf_token %}
            <button type="submit" class="btn btn-outline-danger btn-sm">End session</button>
        </form>
        {% endif %}
    </div>
    {% if participant_display %}
    <div class="small text-muted mt-2">You are editing as {{ participant_display }}.</div>
    {% endif %}
</div>
<style>
  #onlyoffice-editor {
    width: 100%;
    min-height: 420px;
    height: 100%;
    border: 1px solid var(--bs-border-color);
    border-radius: 0.5rem;
    overflow: hidden;
  }

  @media (max-width: 768px) {
    #onlyoffice-editor {
      min-height: 360px;
    }
  }
</style>
<div id="onlyoffice-editor"></div>
{{ editor_config|json_script:"onlyoffice-editor-config" }}
<script src="{{ onlyoffice_js_url }}"></script>
<script>
    (function() {
        const container = document.getElementById('onlyoffice-editor');
        const errorMessage = `<div class="p-4 text-danger">Unable to load the OnlyOffice editor. Check your OnlyOffice configuration.</div>`;
        if (!container) {
            console.error('OnlyOffice editor container is missing.');
            return;
        }

        const configElement = document.getElementById('onlyoffice-editor-config');
        if (!configElement) {
            console.error('OnlyOffice editor configuration element is missing.');
            container.innerHTML = errorMessage;
            return;
        }

        let config;
        try {
            config = JSON.parse(configElement.textContent);
        } catch (error) {
            console.error('OnlyOffice editor configuration is invalid.', error);
            container.innerHTML = errorMessage;
            return;
        }

        const MIN_HEIGHT = 420;

        function calculateEditorHeight() {
            const viewportHeight = window.innerHeight || document.documentElement.clientHeight || MIN_HEIGHT;
            const header = document.querySelector('.collab-header');
            const navbar = document.querySelector('nav.navbar');
            const headerHeight = header ? header.offsetHeight : 0;
            const navbarHeight = navbar ? navbar.offsetHeight : 0;
            const paddingOffset = 24; // offset for body/container padding
            return Math.max(viewportHeight - headerHeight - navbarHeight - paddingOffset, MIN_HEIGHT);
        }

        function applyHeight(height) {
            container.style.height = `${height}px`;
            if (window.docEditor && typeof window.docEditor.resize === 'function') {
                window.docEditor.resize('100%', `${height}px`);
            }
        }

        function initialiseEditor() {
            const height = calculateEditorHeight();
            container.style.height = `${height}px`;
            config.width = '100%';
            config.height = `${height}px`;
            window.docEditor = new DocsAPI.DocEditor('onlyoffice-editor', config);
        }

        function handleResize() {
            applyHeight(calculateEditorHeight());
        }

        if (window.DocsAPI && window.DocsAPI.DocEditor) {
            initialiseEditor();
            window.addEventListener('resize', handleResize);
            window.addEventListener('load', handleResize);
        } else {
            console.error('OnlyOffice DocsAPI is not available.');
            container.innerHTML = errorMessage;
        }
    })();
</script>
{% endblock %}
